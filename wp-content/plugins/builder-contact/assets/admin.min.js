!function($){'use strict';let y;const v=function(e,t){this.$table=$(e),this.top=window.top.document,this.init(t)};v.prototype={$table:null,app:null,init(e){this.app=e,this.loadExtraFields(e.values),this.makeSortable(),this.events()},loadOrders(e,s){let r,n;try{r=JSON.parse(e.field_order)}catch(e){}r=r||{};const t=this.$table[0].getElementsByTagName('tbody')[0],a=t.getElementsByTagName('tr'),l=[],o=document.createDocumentFragment();for(let e=0,t=a.length;e<t;++e)a[e].classList.contains('tb_no_sort')?n=a[e]:l.push(a[e]);l.sort(function(e,t){let n,a,l=e.classList.contains('tb_contact_new_row'),o=t.classList.contains('tb_contact_new_row'),i=function(t){for(let e=s.length-1;-1<e;--e)if((s[e].label===t||s[e].id===t)&&void 0!==s[e].order)return s[e].order;return!1};const c=(l?e.getElementsByClassName('tb_new_field_textbox'):e.getElementsByClassName('tb_lb_option'))[0],d=(o?t.getElementsByClassName('tb_new_field_textbox'):t.getElementsByClassName('tb_lb_option'))[0];return(l&&c.dataset.order?c.dataset.order:(n=l?c.value:c.id,n=(n=l&&''===n?c.dataset.id:n).trim(),void 0!==r[n]?r[n]:!!l&&i(n)))-(o&&d.dataset.order?d.dataset.order:(a=o?d.value:d.id,a=(a=o&&''===a?d.dataset.id:a).trim(),void 0!==r[a]?r[a]:!!o&&i(a)))});for(let e=0,t=l.length;e<t;++e)o.appendChild(l[e]);for(o.appendChild(n);t.firstChild;)t.removeChild(t.lastChild);t.appendChild(o)},loadExtraFields(e){let n,t=this.$table[0].getElementsByClassName('tb_no_sort')[0];try{n=JSON.parse(e.field_extra).fields}catch(e){}n=n||{fields:[]};const a=document.createDocumentFragment();for(let e=0,t=n.length;e<t;++e)a.appendChild(this.addField(n[e]));t.parentNode.insertBefore(a,t),this.loadOrders(e,n)},events(){const n=this;this.$table.on('click.tb_contact','.tb_new_field_action',function(e){e.preventDefault(),e.stopPropagation();const t=this.closest('.tb_no_sort');t.parentNode.insertBefore(n.addField({}),t),n.$table.find('tbody').sortable('refresh'),n.changeObject()}).on('change.tb_contact','.tb_new_field_type',function(){n.switchField(this),n.changeObject()}).on('click.tb_contact','.tb_add_field_option',function(e){e.preventDefault(),e.stopPropagation(),this.previousElementSibling.appendChild(n.render.getOptions([''])),n.changeObject()}).on('keyup.tb_contact','.tb_contact_new_row input[type="text"], .tb_contact_new_row textarea',function(){n.changeObject()}).on('change.tb_contact','.tb_contact_new_row .tb_new_field_required',function(){n.changeObject()}).on('click.tb_contact','.tb_contact_value_remove,.tb_contact_field_remove',function(e){if(e.preventDefault(),e.stopPropagation(),this.classList.contains('tb_contact_value_remove'))$(this).closest('li').remove();else{let e=$(this).closest('.tb_contact_new_row'),t=e.find('.tb_new_field_textbox').val().trim();e.remove(),[...ThemifyBuilderCommon.Lightbox.$lightbox[0].querySelectorAll('.tb_contact_custom_tags span')].filter(function(e){e.textContent.trim()==='%'+t+'%'&&e.parentNode.removeChild(e)})}n.changeObject()})},makeSortable(){const e=this;this.$table.find('tbody').sortable({items:'tr:not(.tb_no_sort)',placeholder:'ui-state-highlight',axis:'y',containment:'parent',update(){e.changeObject()}})},render:{call(e,t){return void 0===this[t]?this._default(e,t):this[t].call(this,e,t)},setType(e,t){e.setAttribute('data-type',t)},getText(e,t,n){const a=document.createElement(n);return'textarea'!==n&&(a.type='tel'!==n?'text':'tel'),e.value&&(e.value=e.value.replace(/\\\\n/g,'\n'),a.value=e.value.replace(/(&quot;)|(\\\\")/g,'"')),a.className='tb_new_field_value tb_field_type_text',this.setType(a,t),a},static(e,t){const n=this._default(e,'textarea');return n.placeholder=tb_contact_l10n.static_text,this.setType(n,'static'),n},upload(e,t){return document.createElement('div')},getOptions(l){const o=document.createDocumentFragment();for(let a in l){let e=document.createElement('li'),t=document.createElement('a'),n=document.createElement('input');n.type='text',n.className='tb_multi_option',n.value=l[a],t.className='tb_contact_value_remove tf_close',t.href='#',e.appendChild(n),e.appendChild(t),o.appendChild(e)}return o},_default(e,t){if('text'===t||'textarea'===t||'tel'===t){const i='textarea'===t?t:'input';return this.getText(e,t,i)}const n=document.createElement('ul'),a=document.createElement('a'),l=document.createDocumentFragment(),o=e.value||[''];return n.appendChild(this.getOptions(o)),l.appendChild(n),a.href='#',a.className='tb_add_field_option',a.textContent=tb_contact_l10n.add_option,this.setType(a,t),l.appendChild(a),l}},addField(e){const t=0===Object.keys(e).length,n=e.type||'text',a=document.createElement('tr'),l=document.createElement('td'),o=document.createElement('input'),i=document.createElement('td'),c=document.createElement('div'),d=document.createElement('select'),s=document.createDocumentFragment(),r=document.createElement('div'),p=document.createElement('div'),m=document.createElement('label'),_=document.createElement('input'),u=document.createElement('a'),h=tb_contact_l10n.types,b='tb_'+tb_app.Utils.generateUniqueID();r.className='control-input tf_rel',p.className='tb_new_field',c.className='selectwrapper',d.className='tb_new_field_type tb_lb_option',a.className='tb_contact_new_row',o.type='text',o.className='tb_new_field_textbox',o.value=void 0===e.label?1==t?tb_contact_l10n.field_name:'':e.label.replace(/&quot;/g,'"'),o.dataset.id=void 0===e.id?'':e.id,o.dataset.order=void 0===e.order?'':e.order,_.type='checkbox',_.className='tb_new_field_required',_.value='required','static'===n&&(m.style.display='none'),!0===e.required&&(_.checked=!0),i.setAttribute('colspan','2'),l.appendChild(o),a.appendChild(l);for(let t in h){let e=document.createElement('option');e.name=b,t===n&&(e.selected='selected'),e.value=t,e.textContent=h[t],s.appendChild(e)}d.appendChild(s),c.appendChild(d),i.appendChild(c),r.appendChild(this.render.call(e,n)),p.appendChild(r),m.appendChild(_),m.appendChild(document.createTextNode(tb_contact_l10n.req)),p.appendChild(m),i.appendChild(p),a.appendChild(i);let f=document.createElement('td'),g=(f.appendChild(u),u.className='tb_contact_field_remove tf_close',u.href='#',a.appendChild(f),document.createElement('span'));return g.appendChild(document.createTextNode('%'+o.value+'%')),ThemifyBuilderCommon.Lightbox.$lightbox[0].querySelector('.tb_contact_custom_tags').appendChild(g),o.addEventListener('change',function(){g.textContent='%'+this.value+'%'}),a},switchField(e){const t=e.value,n=e.closest('td').getElementsByClassName('control-input')[0],a=n.closest('.tb_new_field').getElementsByClassName('tb_new_field_required')[0].parentNode;for(;n.firstChild;)n.removeChild(n.lastChild);n.appendChild(this.render.call({},t)),a.style.display='static'===t?'none':''},changeObject(e){const i=this.$table[0].getElementsByTagName('tbody')[0].getElementsByTagName('tr'),c={fields:[]},t={};for(let o=0,e=i.length;o<e;++o)if(i[o].classList.contains('tb_contact_new_row')){let a=i[o].getElementsByClassName('tb_new_field_type')[0].options[i[o].getElementsByClassName('tb_new_field_type')[0].selectedIndex].value,t=i[o].getElementsByClassName('tb_new_field_textbox')[0].value.trim(),n='static'!==a&&!0===i[o].getElementsByClassName('tb_new_field_required')[0].checked,l;switch(a){case'text':case'textarea':case'static':case'tel':l=i[o].getElementsByClassName('tb_new_field_value')[0].value.trim();break;case'radio':case'select':case'checkbox':l=[];let n=i[o].getElementsByClassName('control-input')[0].getElementsByTagName('input');for(let t=0,e=n.length;t<e;++t){let e=n[t].value.trim();''===e&&'select'!==a||l.push(e)}break}if(''!==l&&void 0!==l||''!==t){let e={type:a,order:o};n&&(e.required=n),''!==t?e.label=t.replace(/"/g,'&quot;'):e.id='ex'+o,void 0!==l&&''!==l&&0<l.length&&('static'===a?l=l.replace(/"/g,'\\\\"'):'text'!==a&&'textarea'!==a||(l=l.replace(/"/g,'&quot;')),'static'!==a&&'textarea'!==a||(l=l.replace(/\n/g,'\\\\n')),e.value=l),c.fields.push(e)}}else if(!i[o].classList.contains('tb_no_sort')){let e=i[o].getElementsByClassName('tb_lb_option')[0].id;t[e]=o}const n=this.top.getElementById('field_extra'),a=JSON.stringify(t);n.value=JSON.stringify(c),this.top.getElementById('field_order').value=a,this.app.settings.field_order=a,e||Themify.triggerEvent(n,'change')}};let E=null;tb_app.Constructor.contact_fields={render(e,l){const t=window.top;null===E&&(E=!0,t.Themify.LoadCss(tb_contact_l10n.admin_css,tb_contact_l10n.v));let o=document.createElement('tr');const a=document.createElement('table'),n=document.createElement('thead'),i=document.createElement('tbody'),c=document.createElement('tfoot'),d=document.createDocumentFragment(),s=e.options.head,r=e.options.body,p=e.options.foot,m=function(e,t,n){const a={id:'field_'+e,placeholder:t,class:'large',type:'text'};return n&&(a.help=n),l.create([a])},_=function(e){const t={id:'field_'+e,new_line:!0,type:'checkbox',options:[{value:'',name:'yes'}]};return'sendcopy_active'===e?t.binding={checked:{show:'field_sendcopy_subject'},not_checked:{hide:'field_sendcopy_subject'}}:'optin_active'===e&&(t.binding={checked:{show:'optin'},not_checked:{hide:'optin'}}),l.create([t])};for(let t in s){let e=document.createElement('th');'l'===t&&(e.colSpan=2),e.textContent=s[t],o.appendChild(e)}n.appendChild(o);for(let a in r){o=document.createElement('tr');for(let e in s){let t=document.createElement('td'),n=null;if('f'===e)n=document.createElement('span'),t.textContent=r[a];else if('l'===e){t.colSpan='2';let e;var u;(e=m(a+'_label',r[a])).appendChild(m(a+'_placeholder',tb_contact_l10n.pl)),n='message'!==a?(g=document.createDocumentFragment(),u=_(a+'_require'),g.appendChild(e),u.querySelector('.tb_lb_option').appendChild(document.createTextNode(tb_contact_l10n.req)),g.appendChild(u),g):e}else'sh'===e&&(n=_(a+'_active'));null!==n&&t.appendChild(n),o.appendChild(t)}d.appendChild(o)}o=document.createElement('tr');const h=document.createElement('td'),b=document.createElement('a'),f=document.createElement('span');b.className='tb_new_field_action',b.href='#',f.className='tf_plus_icon',b.appendChild(f),b.appendChild(document.createTextNode(e.new_row)),h.setAttribute('colspan','4'),h.appendChild(b),o.className='tb_no_sort',o.appendChild(h),d.appendChild(o),i.appendChild(d);for(let a in p)if('align'!==a){o=document.createElement('tr');for(let t in s)if('sh'!==t||'send'!==a){let e=document.createElement('td'),n=null;if('f'===t)e.textContent=p[a];else if('l'===t){e.colSpan=2;let t=m(a+'_label',p[a]);if('send'===a){e.colSpan=3;var g=document.createDocumentFragment(),C=l.select.render({id:p.align.id,options:p.align.options},l);g.appendChild(t),g.appendChild(C),g.appendChild(document.createTextNode(p.align.label)),n=g}else if('optin'===a){n=document.createDocumentFragment();let e=ThemifyConstructor.create([{type:'optin_provider',id:'optin'}]);n.appendChild(t),n.appendChild(e)}else n=t;g.appendChild(u)}else'sh'===t&&'send'!==a&&(n=_(a+'_active'),'captcha'===a&&''!==tb_contact_l10n.captcha&&n.querySelector('input').addEventListener('change',function(e){let t=this.closest('td').previousElementSibling;if(!0===this.checked){const n=document.createElement('div');n.className='tb_captcha_message tb_field_error_msg',n.innerHTML=tb_contact_l10n.captcha,t.appendChild(n)}else{let e=t.getElementsByClassName('tb_captcha_message')[0];void 0!==e&&e.parentNode.removeChild(e)}},{passive:!0}));null!==n&&e.appendChild(n),'l'===t&&'sendcopy'===a&&e.appendChild(l.create([{id:'field_'+a+'_subject',after:tb_contact_l10n.sendcopy_sub,type:'text',class:'small'}])),o.appendChild(e)}d.appendChild(o)}return c.appendChild(d),a.className='contact_fields',a.appendChild(n),a.appendChild(i),a.appendChild(c),document.addEventListener('tb_editing_contact',function(e){const t=ThemifyBuilderCommon.Lightbox.$lightbox,n=t.find('#template');''===n.val()&&n.val(tb_contact_l10n.default_template),y=new v(a,l),Themify.body.one('themify_builder_lightbox_close',function(e){y.$table.off('click.tb_contact keyup.tb_contact change.tb_contact'),y=null}),t[0].querySelector('.template_fields').addEventListener('click',function(e){'span'===e.target.tagName.toLocaleLowerCase()&&(t[0].querySelector('#template').value+=e.target.textContent)})},{once:!0}),a}},'visual'===tb_app.mode&&(document.addEventListener('tb_inline_item',function(e){if(y){const t=e.detail.activeEl;if(null!==t.parentNode.closest('.builder-contact-field-extra')){const n=ThemifyBuilderCommon.Lightbox.$lightbox[0],a=t.previousElementSibling?t.previousElementSibling.type:null,l=t.getAttribute('data-name');if(delete ThemifyConstructor.settings[l],'checkbox'===a||'order'===a){const o=Themify.convert(t.closest('.control-input').querySelectorAll('[data-name]')).indexOf(t);e.detail.el=n.querySelector('[data-order="'+l+'"]').closest('.tb_contact_new_row').getElementsByClassName('tb_multi_option')[o]}else e.detail.el=n.querySelector('[data-order="'+l+'"]');y.changeObject(!0)}}},{passive:!0}),document.addEventListener('tb_inline_save',function(e){const a=e.detail.activeEl;if(null!==a.parentNode.closest('.builder-contact-field-extra')){const t=a.getAttribute('data-name'),n=e.detail.data,l=e.detail.val,o=JSON.parse(n.field_extra),i=o.fields;delete n[t];for(let n=i.length-1;-1<n;--n)if(i[n].order==t){if(!Array.isArray(i[n].value)||a.parentNode.classList.contains('control-label'))i[n].label=l;else for(let e=a.closest('.control-input').children,t=e.length-1;-1<t;--t)if(e[t].contains(a)){i[n].value[t]=l;break}break}n.field_extra=JSON.stringify({fields:i})}},{passive:!0})),tb_app.Forms.register_validator('tb_contact_recipient',function(e){let t=window.top.document.getElementById('send_to_admins').querySelector('.tb-checkbox');return!!t.checked||''!==e.trim()&&(e=e.split(',').map(e=>e.trim())).every(e=>tb_app.Forms.get_validator('email')(e));return!0})}(jQuery);